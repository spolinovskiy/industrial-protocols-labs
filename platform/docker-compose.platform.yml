version: "3.9"

services:
  # FUXA SCADA (shared across all labs)
  fuxa:
    image: frangoteam/fuxa:latest
    container_name: fuxa
    networks:
      - platform_net
      - modbus_net
      - opcua_net
      - bacnet_net
      - cip_net
      - dnp3_net
      - iec104_net
      - mqtt_net
      - s7_net
    volumes:
      - "./fuxa/volumes/appdata:/usr/src/app/FUXA/server/_appdata"
      - "./fuxa/volumes/db:/usr/src/app/FUXA/server/_db"
      - "./fuxa/volumes/logs:/usr/src/app/FUXA/server/_logs"
      - "./fuxa/volumes/images:/usr/src/app/FUXA/server/_images"
    environment:
      - PORT=1881
    restart: always
    labels:
      - "com.example.role=scada"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

  # Guest-only FUXA (Modbus Test Bench only)
  fuxa_guest:
    image: frangoteam/fuxa:latest
    container_name: fuxa_guest
    networks:
      - platform_net
      - modbus_net
    volumes:
      - "./fuxa_guest/volumes/appdata:/usr/src/app/FUXA/server/_appdata"
      - "./fuxa_guest/volumes/db:/usr/src/app/FUXA/server/_db"
      - "./fuxa_guest/volumes/logs:/usr/src/app/FUXA/server/_logs"
      - "./fuxa_guest/volumes/images:/usr/src/app/FUXA/server/_images"
    environment:
      - PORT=1883
    restart: always
    labels:
      - "com.example.role=scada-guest"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # Diagnostics (termshark + ttyd menu)
  diagnostics:
    build:
      context: ./diagnostics
    container_name: diagnostics
    # Use host network so tcpdump can see traffic between other containers.
    network_mode: host
    volumes:
      - "./diagnostics/capture:/work/capture"
    environment:
      - TTYD_PORT=7681
      - TTYD_USER=proto-researcher
      - TTYD_PASS=lab123
      - DIAG_AUTH=0
      - DIAG_ALLOW_SHELL=0
      - CAP_DURATION=10
      - CAP_MAX_FILES=20
      - CAP_RETENTION_DAYS=3
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: always
    labels:
      - "com.example.role=diagnostics"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  # Nginx auth gateway (guest + admin)
  gateway:
    image: nginx:alpine
    container_name: gateway
    depends_on:
      - fuxa
      - fuxa_guest
      - diagnostics
    networks:
      - platform_net
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "1881:1881"  # guest (view-only)
      - "1882:1882"  # admin (full)
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./nginx/auth:/etc/nginx/auth:ro"
    restart: always
    labels:
      - "com.example.role=gateway"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # Lab switcher API (controls protocol selection)
  lab-switcher:
    build:
      context: ./lab_switcher
    container_name: lab-switcher
    networks:
      - platform_net
    volumes:
      - ../:/lab
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LAB_SWITCHER_HOST=0.0.0.0
      - LAB_SWITCHER_PORT=8090
      - LAB_SWITCHER_TOKEN=${LAB_SWITCHER_TOKEN:-}
    ports:
      - "8090:8090"
    restart: always
    labels:
      - "com.example.role=lab-switcher"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # Frontend app (production build)
  frontend:
    build:
      context: ../frontend
      args:
        - VITE_LAB_GUEST_URL=/guest
        - VITE_LAB_ADMIN_URL=/admin
    container_name: frontend
    networks:
      - platform_net
    environment:
      - PORT=5000
      - LAB_SWITCHER_URL=http://lab-switcher:8090
      - LAB_GUEST_URL=/guest
      - LAB_ADMIN_URL=/admin
      - LAB_DIAG_URL=/diag
      - LAB_API_TOKEN=${LAB_API_TOKEN:-}
      - LOCAL_AUTH_MODE=${LOCAL_AUTH_MODE:-login}
      - LOCAL_AUTH_PASSWORD=${LOCAL_AUTH_PASSWORD:-}
      - SESSION_SECRET=${SESSION_SECRET:-local-dev-secret}
      - CSRF_ALLOW_MISSING=${CSRF_ALLOW_MISSING:-1}
    restart: always
    labels:
      - "com.example.role=frontend"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # Web reverse proxy (front page + guest/admin/diag)
  web:
    image: nginx:alpine
    container_name: web
    depends_on:
      - frontend
      - gateway
    networks:
      - platform_net
    ports:
      - "8080:8080"
    volumes:
      - "./web/nginx.conf:/etc/nginx/nginx.conf:ro"
    restart: always
    labels:
      - "com.example.role=web"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # Reset controller (session TTL + idle timeout)
  reset-controller:
    build:
      context: ./reset
    container_name: reset-controller
    networks:
      - platform_net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/lab/platform:ro
      - "./diagnostics/capture:/lab/capture"
      - "./fuxa/volumes:/lab/fuxa"
      - "./fuxa/seeds:/lab/seeds:ro"
      - "./active_protocol:/lab/active_protocol"
    restart: always
    labels:
      - "com.example.role=reset"
      - "com.example.stack=platform"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 64M

  # --- Protocol servers (exactly one active at a time) ---

  proto-server-modbus:
    build:
      context: ../protocols/modbus/server
    container_name: proto-server-modbus
    profiles: ["modbus"]
    ports:
      - "502:502"
    networks:
      modbus_net:
        aliases:
          - modbus-server
          - modbus
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=modbus"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-opcua:
    build:
      context: ../protocols/opcua/server
    container_name: proto-server-opcua
    profiles: ["opcua"]
    ports:
      - "4840:4840"
    networks:
      - opcua_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=opcua"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-bacnet:
    build:
      context: ../protocols/bacnet/server
    container_name: proto-server-bacnet
    profiles: ["bacnet"]
    ports:
      - "47808:47808/udp"
    networks:
      - bacnet_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=bacnet"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-cip:
    build:
      context: ../protocols/cip/server
    container_name: proto-server-cip
    profiles: ["cip"]
    ports:
      - "44818:44818"
    networks:
      - cip_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=cip"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-gateway-cip:
    build:
      context: ../protocols/cip/gateway
    container_name: proto-gateway-cip
    profiles: ["cip"]
    environment:
      - CIP_ADDRESS=proto-server-cip
    networks:
      - platform_net
      - cip_net
    restart: always
    labels:
      - "com.example.role=proto-gateway"
      - "com.example.protocol=cip"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-dnp3:
    build:
      context: ../protocols/dnp3/server
    container_name: proto-server-dnp3
    profiles: ["dnp3-full"]
    ports:
      - "20000:20000"
    networks:
      - dnp3_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=dnp3"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-gateway-dnp3:
    build:
      context: ../protocols/dnp3/gateway
    container_name: proto-gateway-dnp3
    profiles: ["dnp3"]
    environment:
      - DNP3_HOST=proto-server-dnp3
      - DNP3_PORT=20000
    networks:
      - platform_net
      - dnp3_net
    restart: always
    labels:
      - "com.example.role=proto-gateway"
      - "com.example.protocol=dnp3"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-iec104:
    build:
      context: ../protocols/iec104/server
    container_name: proto-server-iec104
    profiles: ["iec104"]
    ports:
      - "2404:2404"
    networks:
      - iec104_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=iec104"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-gateway-iec104:
    build:
      context: ../protocols/iec104/gateway
    container_name: proto-gateway-iec104
    profiles: ["iec104"]
    networks:
      - platform_net
      - iec104_net
    restart: always
    labels:
      - "com.example.role=proto-gateway"
      - "com.example.protocol=iec104"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  proto-server-mqtt:
    image: eclipse-mosquitto:2
    container_name: proto-server-mqtt
    profiles: ["mqtt"]
    networks:
      - mqtt_net
    volumes:
      - "../protocols/mqtt/broker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro"
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=mqtt"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  proto-server-mqtt-bridge:
    build:
      context: ../protocols/mqtt/device-bridge
    container_name: proto-server-mqtt-bridge
    profiles: ["mqtt"]
    depends_on:
      - proto-server-mqtt
    networks:
      - mqtt_net
    environment:
      - MQTT_HOST=proto-server-mqtt
      - MQTT_PORT=1883
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=mqtt"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  proto-server-s7:
    build:
      context: ../protocols/s7/plc-sim
    container_name: proto-server-s7
    profiles: ["s7"]
    ports:
      - "102:102"
    networks:
      - s7_net
    restart: always
    labels:
      - "com.example.role=proto-server"
      - "com.example.protocol=s7"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

  # --- Optional clients (disabled by default) ---

  proto-client-modbus:
    build:
      context: ../protocols/modbus/client
    container_name: proto-client-modbus
    profiles: ["modbus-test"]
    depends_on:
      - proto-server-modbus
    networks:
      - modbus_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=modbus"

  proto-client-opcua:
    build:
      context: ../protocols/opcua/client
    container_name: proto-client-opcua
    profiles: ["opcua-test"]
    depends_on:
      - proto-server-opcua
    networks:
      - opcua_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=opcua"

  proto-client-bacnet:
    build:
      context: ../protocols/bacnet/client
    container_name: proto-client-bacnet
    profiles: ["bacnet-test"]
    depends_on:
      - proto-server-bacnet
    networks:
      - bacnet_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=bacnet"

  proto-client-cip:
    build:
      context: ../protocols/cip/client
    container_name: proto-client-cip
    profiles: ["cip-test"]
    depends_on:
      - proto-server-cip
    networks:
      - cip_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=cip"

  proto-client-dnp3:
    build:
      context: ../protocols/dnp3/client
    container_name: proto-client-dnp3
    profiles: ["dnp3-test"]
    depends_on:
      - proto-server-dnp3
    networks:
      - dnp3_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=dnp3"

  proto-client-iec104:
    build:
      context: ../protocols/iec104/client
    container_name: proto-client-iec104
    profiles: ["iec104-test"]
    depends_on:
      - proto-server-iec104
    networks:
      - iec104_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=iec104"

  proto-client-mqtt:
    build:
      context: ../protocols/mqtt/client
    container_name: proto-client-mqtt
    profiles: ["mqtt-test"]
    depends_on:
      - proto-server-mqtt
      - proto-server-mqtt-bridge
    networks:
      - mqtt_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=mqtt"

  proto-client-s7:
    build:
      context: ../protocols/s7/client
    container_name: proto-client-s7
    profiles: ["s7-test"]
    depends_on:
      - proto-server-s7
    networks:
      - s7_net
    labels:
      - "com.example.role=proto-client"
      - "com.example.protocol=s7"

networks:
  platform_net:
    driver: bridge
    labels:
      - "k8s.network=platform"

  modbus_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.10.0/24
    labels:
      - "k8s.network=internal"

  opcua_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.20.0/24
    labels:
      - "k8s.network=internal"

  bacnet_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.30.0/24
    labels:
      - "k8s.network=internal"

  cip_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.40.0/24
    labels:
      - "k8s.network=internal"

  dnp3_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.50.0/24
    labels:
      - "k8s.network=internal"

  iec104_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.60.0/24
    labels:
      - "k8s.network=internal"

  mqtt_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.70.0/24
    labels:
      - "k8s.network=internal"

  s7_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.80.0/24
    labels:
      - "k8s.network=internal"
